name: promote-develop-to-main

on:
  pull_request:
    branches: [develop]
    types: [closed]

permissions:
  contents: write         # needed to push/merge
  pull-requests: write    # needed to create/merge PRs

jobs:
  if-merged:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      QT_QPA_PLATFORM: offscreen
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop

      # (Optional) sanity test on the post-merge state of 'develop'
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - name: Install & test
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest
          pytest -q

      - name: Ensure PR develop -> main exists (or create it)
        run: |
          # Look for an open PR from develop to main
          NUM=$(gh pr list --base main --head develop --state open --json number -q '.[0].number')
          if [ -z "$NUM" ]; then
            gh pr create \
              --base main \
              --head develop \
              --title "Promote develop to main" \
              --body "Automated PR created after merges into **develop**. Will auto-merge once checks pass."
            NUM=$(gh pr list --base main --head develop --state open --json number -q '.[0].number')
          fi
          echo "PR_NUMBER=$NUM" >> $GITHUB_ENV

      - name: Enable auto-merge on the PR
        run: |
          # Requires repo setting "Allow auto-merge" enabled
          gh pr merge "$PR_NUMBER" --auto --squash
